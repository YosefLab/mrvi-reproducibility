nextflow.enable.dsl = 2

profiles {
    standard {
        process.executor = "local"
    }
    gpu {
        process.executor = "local"
    }
}

conda {
    enabled = true
    cacheDir = "${projectDir}/env/.cache"
    useMamba = true
}

params {
    // environments are defined per subworkflow
    env {
        root = "${projectDir}/env/${params.profile}"
        preprocess_data = "${params.env.root}/preprocess_data.yaml"
        run_models = "/home/pierre/miniconda3/envs/run-models"
        compute_metrics = "${params.env.root}/compute_metrics.yaml"
        analyze_results = "${params.env.root}/analyze_results.yaml"
    }
    conf {
        root = "${projectDir}/conf"
        datasets = "${params.conf.root}/datasets"
    }
    publish {
        root = "${projectDir}/results"
    }
    workflows {
        root = "${projectDir}/workflows"
    }
    subworkflows {
        root = "${projectDir}/subworkflows"
        preprocess_data = "${params.subworkflows.root}/preprocess_data/main.nf"
        run_models = "${params.subworkflows.root}/run_models/main.nf"
        compute_metrics = "${params.subworkflows.root}/compute_metrics/main.nf"
        analyze_results = "${params.subworkflows.root}/analyze_results/main.nf"
    }
    modules {
        root = "${projectDir}/modules"
        preprocess = "${params.modules.root}/preprocess.nf"
        fit_mrvi = "${params.modules.root}/fit_mrvi.nf"
        get_latent_mrvi = "${params.modules.root}/get_latent_mrvi.nf"
        fit_scviv2 = "${params.modules.root}/fit_scviv2.nf"
        get_latent_scviv2 = "${params.modules.root}/get_latent_scviv2.nf"
        get_outputs_scviv2 = "${params.modules.root}/get_outputs_scviv2.nf"
        fit_and_get_latent_composition_scvi = "${params.modules.root}/fit_and_get_latent_composition_scvi.nf"
        fit_and_get_latent_composition_pca = "${params.modules.root}/fit_and_get_latent_composition_pca.nf"
        scib = "${params.modules.root}/scib.nf"
        vendi = "${params.modules.root}/vendi.nf"
        produce_figures = "${params.modules.root}/produce_figures.nf"
    }
    bin {
        root = "${projectDir}/bin"
        preprocess = "${params.bin.root}/preprocess.py"
        fit_mrvi = "${params.bin.root}/fit_mrvi.py"
        get_latent_mrvi = "${params.bin.root}/get_latent_mrvi.py"
        fit_scviv2 = "${params.bin.root}/fit_scviv2.py"
        get_latent_scviv2 = "${params.bin.root}/get_latent_scviv2.py"
        get_outputs_scviv2 = "${params.bin.root}/get_outputs_scviv2.py"
        fit_and_get_latent_composition_scvi = "${params.bin.root}/fit_and_get_latent_composition_scvi.py"
        fit_and_get_latent_composition_pca = "${params.bin.root}/fit_and_get_latent_composition_pca.py"
        scib = "${params.bin.root}/scib.py"
        vendi = "${params.bin.root}/vendi.py"
        produce_figures_symsim_new = "${params.bin.root}/produce_figures_symsim_new.py"
    }
    inputs = "data/*.h5ad"
    // only relative paths need to be specified here since module outputs
    // are placed in temporary work directories
    outputs {
        data = "data"
        models = "models"
        metrics = "metrics"
    }
}

process {
    publishDir = "${params.publish.root}/${params.workflow}"
    withName: "preprocess" {
        conda = "${params.env.preprocess_data}"
    }
    withName: "fit_mrvi" {
        conda = "${params.env.run_models}"
    }
    withName: "get_latent_mrvi" {
        conda = "${params.env.run_models}"
    }
    withName: "get_outputs_scviv2" {
        conda = "${params.env.run_models}"
    }
    withName: "fit_scviv2" {
        conda = "${params.env.run_models}"
    }
    withName: "get_latent_scviv2" {
        conda = "${params.env.run_models}"
    }
    withName: "fit_and_get_latent_composition_scvi" {
        conda = "${params.env.run_models}"
    }
    withName: "fit_and_get_latent_composition_pca" {
        conda = "${params.env.run_models}"
    }
    withName: "scib" {
        conda = "${params.env.compute_metrics}"
    }
    withName: "vendi" {
        conda = "${params.env.compute_metrics}"
    }
    withName: "produce_figures_symsim_new" {
        conda = "${params.env.analyze_results}"
    }
}

// params.workflow is passed in from the command line as --workflow
includeConfig "${params.conf.root}/${params.workflow}.config"
